# **The Fundamentals of Controls**

So now we know how to make subsystems, create commands, and bind those commands to triggers. But how do we actually control a motor to make it do what we want to do?

Here is where control theory comes in. In this lesson we are going to cover PID and FeedForward control. These are both common types of controls that are used all over FRC. We will end the lesson by combining the two methods of control utilizing something called a trapezoidal motion profile.

## **PID**

PID is a form closed loop control. Closed loop control is where a control system activly uses feedback from motors or encoders to adjust for disturbances and noise in a system. PID is a system of control involving three gains: Proportional, Integral, and Derivative.

<figure markdown="span">
    ![PID Controller](../img/pid_controller.png){ width="600" }
  <figcaption>A Diagram of the PID Controller System</figcaption>
</figure>
### **1. Proportional**

* This term scales linearly with the distance away from the setpoint
* It covers the majority of the output of the controller

### **2. Integral**

* This term scales linearly with the area under the curve between the setpoint and ouput
* Used for small positional errors that proportional can't overcome

### **3. Derivative**

* This term scales based on the velocity of the output
* Often not necessary for control

### **The PID Equation**
Each of these terms are combined into this equation:

$$
u\left(t\right)=K_{p}e\left(t\right)+K_{i}\int_{0}^{t}e\left(\tau\right)d\tau+K_{d}\frac{de\left(t\right)}{dt}
$$

### **Tuning**

Tuning a PID controller is a somewhat difficult process. Generally start by increasing the proportional term until the system oscilates around the setpoint. Back this term off a little. Then if the system overshoots the target increase the derivative term. If the system has a steady state error where it doesn't quite reach the target increase the integral term. Other than that its alot of trial and error to find the right values.

!!! note
    In control theory you will often see the motor or mechanism your trying to control refered to as the ```plant```.

Try to see if you can find gains that will reach the setpoint without overshooting in this PID simulator:

<div id="chartContainer" style="width:700px; height: 400px; background: #2d2d2d; border-radius: 8px; margin-bottom: 20px;">
    <canvas id="pidChart" style="width: 100%; height: 100%;"></canvas>
</div>

<div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
    <div style="margin: 10px 0; width: 300px;">
        <label for="kp" style="display: block; margin-bottom: 5px;">K (Proportional): <span id="kpValue" style="font-size: 18px; font-weight: bold; color: #ff6b6b;">0.0</span></label>
        <input type="range" id="kp" min="0" max="1" step="0.01" value="0.0" style="width: 100%; height: 8px; background: #333; outline: none; border-radius: 4px;">
        <style>
            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 20px;
                height: 20px;
                background: #ff6b6b;
                border-radius: 50%;
                cursor: pointer;
            }
        </style>
    </div>
    <div style="margin: 10px 0; width: 300px;">
        <label for="ki" style="display: block; margin-bottom: 5px;">Ki (Integral): <span id="kiValue" style="font-size: 18px; font-weight: bold; color: #ff6b6b;">0.0</span></label>
        <input type="range" id="ki" min="0" max="0.1" step="0.001" value="0.0" style="width: 100%; height: 8px; background: #333; outline: none; border-radius: 4px;">
    </div>
    <div style="margin: 10px 0; width: 300px;">
        <label for="kd" style="display: block; margin-bottom: 5px;">Kd (Derivative): <span id="kdValue" style="font-size: 18px; font-weight: bold; color: #ff6b6b;">0.0</span></label>
        <input type="range" id="kd" min="0" max="1" step="0.02" value="0.0" style="width: 100%; height: 8px; background: #333; outline: none; border-radius: 4px;">
    </div>
</div>

<script src="../../assets/pid-sim.js"></script>

## **FeedForward**

## **PID + FeedForward**

## **Trapezoidal Motion Profiles**

<!-- 


<div class="pid-controls">
  <div><label for="kp">Kp:</label><input type="range" id="kp" min="0" max="10" step="0.1" value="1"><span id="kpVal">1</span></div>
  <div><label for="ki">Ki:</label><input type="range" id="ki" min="0" max="5" step="0.01" value="0"><span id="kiVal">0</span></div>
  <div><label for="kd">Kd:</label><input type="range" id="kd" min="0" max="2" step="0.01" value="0.1"><span id="kdVal">0.1</span></div>
  <div><label for="setpoint">Setpoint:</label><input type="range" id="setpoint" min="0" max="2" step="0.1" value="1"><span id="setpointVal">1</span></div>
  <div><label for="duration">Duration (s):</label><input type="range" id="duration" min="1" max="20" step="1" value="10"><span id="durationVal">10</span></div>
  <br>
  <button id="playBtn">Start Live Sim</button>
  <button id="resetBtn">Reset</button>
</div>

<div style="position: relative; height: 400px;">
  <canvas id="pidChart"></canvas>
</div>

<script src="/assets/pid-sim.js"></script>
<script src="/assets/pid-controls.js"></script>
<link rel="stylesheet" href="/assets/pid-controls.css"> -->